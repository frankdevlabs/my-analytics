generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Pageview {
  id                    String     @id @default(cuid())
  added_iso             DateTime   @db.Timestamptz(3)
  path                  String     @db.VarChar(2000)
  country_code          String?    @db.Char(2)
  device_type           DeviceType
  document_referrer     String?    @db.VarChar(2000)
  utm_source            String?    @db.VarChar(255)
  duration_seconds      Int
  is_unique             Boolean    @default(false)
  created_at            DateTime   @default(now()) @db.Timestamptz(3)
  hostname              String?    @db.VarChar(255)
  page_id               String     @unique @default(dbgenerated("('clq'::text || replace((gen_random_uuid())::text, '-'::text, ''::text))"))
  document_title        String?    @db.VarChar(500)
  hash                  String?    @db.VarChar(1000)
  query_string          String?    @db.VarChar(2000)
  session_id            String?    @db.VarChar(255)
  is_bot                Boolean    @default(false)
  is_internal_referrer  Boolean    @default(false)
  browser_name          String?    @db.VarChar(100)
  browser_version       String?    @db.VarChar(50)
  os_name               String?    @db.VarChar(100)
  os_version            String?    @db.VarChar(50)
  viewport_width        Int?
  viewport_height       Int?
  screen_width          Int?
  screen_height         Int?
  language              String?    @db.VarChar(10)
  timezone              String?    @db.VarChar(100)
  user_agent            String     @default("") @db.VarChar(1000)
  utm_medium            String?    @db.VarChar(255)
  utm_campaign          String?    @db.VarChar(255)
  utm_content           String?    @db.VarChar(255)
  utm_term              String?    @db.VarChar(255)
  scrolled_percentage   Int?
  time_on_page_seconds  Int?
  visibility_changes    Int        @default(0)
  referrer_domain       String?    @db.VarChar(255)
  referrer_category     String?    @db.VarChar(50)
  browser_major_version String?    @db.VarChar(10)
  events                Event[]

  @@index([added_iso], map: "idx_pageviews_timestamp")
  @@index([path, added_iso], map: "idx_pageviews_path_timestamp")
  @@index([country_code, added_iso], map: "idx_pageviews_country_timestamp")
  @@index([session_id, added_iso], map: "idx_pageviews_session_timestamp")
  @@index([session_id], map: "idx_pageviews_session_id")
  @@index([is_bot], map: "idx_pageviews_is_bot")
  @@index([referrer_domain, added_iso], map: "idx_pageviews_referrer_domain")
  @@index([referrer_category, added_iso], map: "idx_pageviews_referrer_category")
  @@index([device_type, added_iso], map: "idx_pageviews_device_timestamp")
  @@index([browser_name, added_iso], map: "idx_pageviews_browser_timestamp")
  @@map("pageviews")
}

model Event {
  id             String    @id @default(cuid())
  event_name     String    @db.VarChar(255)
  event_metadata Json?
  page_id        String?   @db.VarChar(255)
  session_id     String?   @db.VarChar(255)
  timestamp      DateTime  @default(now()) @db.Timestamptz(3)
  path           String    @db.VarChar(2000)
  country_code   String?   @db.Char(2)
  pageview       Pageview? @relation(fields: [page_id], references: [page_id])

  @@index([event_name, timestamp], map: "idx_events_name_timestamp")
  @@index([session_id, timestamp], map: "idx_events_session_timestamp")
  @@index([page_id], map: "idx_events_page_id")
  @@map("events")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique @db.VarChar(255)
  password    String       @db.VarChar(255)
  name        String?      @db.VarChar(255)
  createdAt   DateTime     @default(now()) @db.Timestamptz(3)
  mfaEnabled  Boolean      @default(false)
  mfaSecret   String?      @db.VarChar(500)
  backupCodes BackupCode[]

  @@index([email], map: "idx_users_email")
  @@map("users")
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  code      String    @db.VarChar(255)
  used      Boolean   @default(false)
  usedAt    DateTime? @db.Timestamptz(3)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_backup_codes_user_id")
  @@map("backup_codes")
}

enum DeviceType {
  desktop
  mobile
  tablet
}
